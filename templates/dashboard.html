{% extends 'layout.html' %}
{% block title %}Dashboard Global AMT Transit{% endblock %}

{% block content %}
<!-- <div x-show="main_tab === 'perf'" x-transition>
    <div x-data="{ tab: 'perf' }" class="space-y-6">
        <div class="flex gap-2">
            <button @click="tab = 'perf'" :class="tab === 'perf' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-4 py-2 rounded-lg font-semibold transition">Performance</button>
            <button @click="tab = 'fin'" :class="tab === 'fin' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700'" class="px-4 py-2 rounded-lg font-semibold transition">Finances</button>
        </div>
        
        <div x-show="tab === 'perf'" x-transition>
          <h1>performance</h1>
            </div>

        <div x-show="tab === 'fin'" x-transition>
            </div>
    </div>
</div> -->
<div x-show="main_tab === 'perf'" x-transition class="space-y-6">
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Volume total expédié</p>
            <p class="text-xl font-bold text-blue-700">{{ perf_kpi.volume_total|mille }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Nombre d'expéditions</p>
            <p class="text-lg font-bold text-green-600">{{ perf_kpi.nb_expeditions|mille }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Types de colis distincts</p>
            <p class="text-xl font-bold text-purple-600">{{ perf_kpi.nb_types_colis }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Jour le plus chargé</p>
            <p class="text-xl font-bold text-red-600">{{ perf_kpi.jour_plus_charge }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Taux de croissance</p>
            <p class="text-xl font-bold text-red-600">{{ perf_kpi.taux_croissance }}</p>
        </div>
        
        
    </div>
    <div class="space-y-6">
        <div class="bg-white p-4 rounded-lg shadow">{{ perf_g1|safe }}</div>
        <div class="bg-white p-4 rounded-lg shadow">{{ perf_g2|safe }}</div>
        <div class="bg-white p-4 rounded-lg shadow">{{ perf_g3|safe }}</div>
        

        

        <div class="bg-white p-4 rounded-xl shadow mt-6 overflow-x-auto">
            <h2 class="text-lg font-semibold text-center mb-2">Taux de croissance mensuelle</h2>
            {{ growth_table|safe }}
        </div>
         


    </div>
</div>

<div x-show="main_tab === 'fin'" x-transition class="space-y-6">
    <!-- ===================== LIGNE 1 : 4 KPI ===================== -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    {% for kpi in [
        ['CA encaissé', fin_kpi.ca_total|mille ~ ' FCFA'],
        ['Montant restant à payer', fin_kpi.restant_total|mille ~ ' FCFA'],
        ['Taux d\'encaissement', fin_kpi.taux_encaissement ~ ' %'],
        ['CA moyen / expédition', fin_kpi.ca_moyen_expedition ~ ' FCFA']
    ] %}
        <div class="bg-white p-4 rounded-xl shadow text-center">
        <p class="text-md text-yellow-500">{{ kpi[0] }}</p>
        <p class="text-xl font-bold text-slate-600">{{ kpi[1] }}</p>
        </div>
    {% endfor %}
    </div>

    <!-- ===================== LIGNE 2 : 1 graphique + 2 KPI ===================== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Graphique 1 : Top 10 CA -->
    <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow">
        <h2 class="text-lg font-semibold text-center mb-2">Top 10 clients par chiffre d'affaires</h2>
        {{ fin_g1|safe }}
    </div>

    <!-- 2 KPI verticaux -->
    <div class="space-y-4">
        <div class="bg-white p-4 rounded-xl shadow text-center">
        <p class="text-md text-yellow-500">Client top CA</p>
        <p class="text-xl font-bold text-slate-600">{{ fin_kpi.top_client_ca }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
        <p class="text-md text-yellow-500">Client top impayés</p>
        <p class="text-xl font-bold text-slate-600">{{ fin_kpi.top_client_impaye }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
        <p class="text-md text-yellow-500">Taux impayés moyen</p>
        <p class="text-xl font-bold text-slate-600">{{ fin_kpi.taux_impaye_moyen }}</p>
        </div>
    </div>
    </div>

    <!-- ===================== LIGNE 3 : 2 GRAPHIQUES côte à côte ===================== -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Top impayés -->
    <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-lg font-semibold text-center mb-2">Top 10 clients par impayés</h2>
        {{ fin_g2|safe }}
    </div>

    <!-- CA vs impayés mensuel -->
    <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-lg font-semibold text-center mb-2">CA vs Impayés (mensuel)</h2>
        {{ fin_g3|safe }}
    </div>
    </div>

</div>

<div x-show="main_tab === 'clients'" x-transition class="space-y-6">
    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Nombre total de clients</p>
            <p class="text-xl font-bold text-blue-700">{{ clients_kpi.nb_client|mille }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Top 1 client (CA)</p>
            <p class="text-lg font-bold text-green-600">{{ clients_kpi.top1_ca_nom }} ({{ "%.0f"|format(clients_kpi.top1_ca_valeur) }} F)</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Top 1 client (Livraisons)</p>
            <p class="text-xl font-bold text-purple-600">{{ clients_kpi.top1_liv_nom }} ({{ clients_kpi.top1_liv_valeur }})</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
            <p class="text-sm text-gray-500">Taux moyen d'impayé</p>
            <p class="text-xl font-bold text-red-600">{{ clients_kpi.taux_moyen_impaye }} %</p>
        </div>
    </div>
    <div class="space-y-8">
        <div class="bg-white p-4 rounded-lg shadow">{{ clients_g1|safe }}</div>
        <div class="bg-white p-4 rounded-lg shadow">{{ clients_g2|safe }}</div>
        <div class="bg-white p-4 rounded-lg shadow">{{ clients_g3|safe }}</div>
    </div>
</div>

<div x-show="main_tab === 'logistique'" x-transition class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <p class="text-sm text-gray-600">Nb. total d’expéditions</p>
            <p class="text-2xl font-bold text-blue-700">{{ logistique_kpi.nb_expeditions|mille }}</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <p class="text-sm text-gray-600">Volume total expédié</p>
            <p class="text-2xl font-bold text-green-700">{{ logistique_kpi.volume_total|mille }}</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <p class="text-sm text-gray-600">Nombre de types de colis</p>
            <p class="text-2xl font-bold text-purple-700">{{ logistique_kpi.nb_types_colis }}</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <p class="text-sm text-gray-600">Colis le plus fréquent</p>
            <p class="text-xl font-semibold text-orange-700">{{ logistique_kpi.type_plus_frequent }}</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow text-center">
            <p class="text-sm text-gray-600">Client avec le + de volume</p>
            <p class="text-xl font-semibold text-red-700">{{ logistique_kpi.client_top_volume }}</p>
        </div>
        
    </div>    
    <div class="space-y-8">
        <div class="bg-white p-4 rounded-lg shadow">{{ logistique_g1|safe }}</div>
        <div class="bg-white p-4 rounded-lg shadow">{{ logistique_g2|safe }}</div>
        <div class="bg-white p-4 rounded-lg shadow">{{ logistique_g3|safe }}</div>
    </div>
</div>

<div x-show="main_tab === 'tournees'" x-transition class="space-y-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">Carte interactive des livraisons</h1>

        <form method="POST" action="{{ url_for('tournees') }}" class="mb-6">
            <label for="date_unique" class="block mb-2 text-sm font-medium text-gray-900">Choisir une date de livraison :</label>
            <select id="date_unique" name="date_specifique" class="block w-full p-2 border border-gray-300 rounded">
                {% for d in dates_disponibles %}
                  <option value="{{ d }}" {% if selected_date == d|string %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Afficher la carte</button>
        </form>

        <!-- Carte Mapbox -->
        <div class="mb-8">
            {{ tournees_map | safe }}
        </div>

        <!-- Itinéraire optimisé -->
        <div>
            {{ tournees_route | safe }}
        </div>
    </div>
    <div >
  
    {{ directions_text | safe }}
</div>
</div>



<div x-show="main_tab === 'alertes'" x-transition>
    <div class="max-w-4xl mx-auto mt-8 p-8 bg-white rounded-2xl shadow-2xl border">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-3xl font-bold text-blue-900">Rapport Marketing & Commercial</h2>
                <p class="text-lg text-gray-500">Client : <span class="font-semibold text-blue-700">SAS LOGIFRAIS</span></p>
                <p class="text-xs text-gray-400">N° Compte : CLT-001245 &bull; Catégorie : Grand Compte</p>
            </div>
            <img src="https://img.icons8.com/color/96/000000/bar-chart.png" class="w-16 h-16" alt="Graph Icon"/>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <div class="bg-blue-50 rounded-xl p-6 flex flex-col gap-2 shadow-md">
                <span class="text-gray-500 uppercase text-xs">Chiffre d'affaires 2025</span>
                <span class="text-2xl font-extrabold text-blue-900">263 000&nbsp;€</span>
                <span class="text-green-700 text-sm">+7,5% vs N-1</span>
            </div>
            <div class="bg-green-50 rounded-xl p-6 flex flex-col gap-2 shadow-md">
                <span class="text-gray-500 uppercase text-xs">Livraisons réalisées</span>
                <span class="text-2xl font-extrabold text-green-900">412</span>
                <span class="text-blue-700 text-sm">100% livraisons à l'heure</span>
            </div>
            <div class="bg-yellow-50 rounded-xl p-6 flex flex-col gap-2 shadow-md">
                <span class="text-gray-500 uppercase text-xs">Montant impayé</span>
                <span class="text-2xl font-extrabold text-yellow-700">3 120&nbsp;€</span>
                <span class="text-orange-500 text-sm">Taux d'impayés : 1,2%</span>
            </div>
            <div class="bg-indigo-50 rounded-xl p-6 flex flex-col gap-2 shadow-md">
                <span class="text-gray-500 uppercase text-xs">Taux de fidélité</span>
                <span class="text-2xl font-extrabold text-indigo-700">94,8%</span>
                <span class="text-indigo-500 text-sm">Croissance stable</span>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <div>
                <h3 class="text-lg font-bold mb-2 text-blue-700">Évolution mensuelle du CA</h3>
                <canvas id="caChart" class="w-full h-56"></canvas>
            </div>
            <div>
                <h3 class="text-lg font-bold mb-2 text-green-700">Répartition des produits</h3>
                <canvas id="productPie" class="w-full h-56"></canvas>
            </div>
        </div>
        <div class="mb-6">
            <h4 class="text-xl font-semibold mb-2 text-gray-800">Analyse commerciale</h4>
            <ul class="list-disc ml-6 text-gray-700 text-base space-y-1">
                <li>Client très régulier depuis 2019, croissance continue (+7,5% cette année).</li>
                <li>Livraisons principalement sur l’axe Paris – Île-de-France.</li>
                <li>Demande croissante pour la logistique température dirigée (+20% sur la gamme « frais »).</li>
                <li>Très bon comportement de paiement, quelques retards passagers sur Q1 2024.</li>
            </ul>
        </div>
        <div class="mb-6">
            <h4 class="text-xl font-semibold mb-2 text-gray-800">Recommandations marketing</h4>
            <ol class="list-decimal ml-6 text-gray-700 text-base space-y-1">
                <li>Lancer une offre fidélité « Livraison verte » pour encourager l’éco-livraison en centre-ville.</li>
                <li>Proposer une visite du Hub Rungis et valoriser la fiabilité de la chaîne logistique.</li>
                <li>Relancer les contacts pour l’extension « frigo sec ».</li>
                <li>Accentuer la communication sur le taux de service & la traçabilité temps réel.</li>
            </ol>
        </div>
        <div class="bg-yellow-100 rounded-xl p-6 flex flex-col gap-2 shadow-md">
            <span class="font-semibold text-yellow-700">Alerte récente :</span>
            <ul class="list-disc ml-6 text-yellow-800">
                <li>2 livraisons retardées en février pour cause de neige (aucune pénalité appliquée).</li>
                <li>Solde impayé à surveiller malgré régularisation rapide.</li>
            </ul>
        </div>
        <div class="mt-10 flex justify-end">
            <button class="px-6 py-2 rounded-lg bg-blue-700 text-white font-bold shadow hover:bg-blue-900 transition">Exporter en PDF</button>
        </div>
    </div>
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // Données fictives pour le CA
    const caChart = document.getElementById('caChart').getContext('2d');
    new Chart(caChart, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'],
            datasets: [{
                label: 'Chiffre d\'Affaires',
                data: [21000, 18500, 19200, 22500, 24800, 21000, 19800, 25300, 22800, 21000, 23500, 26200],
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37,99,235,0.07)',
                borderWidth: 3,
                fill: true,
                pointRadius: 3,
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            responsive: true,
            scales: { y: { beginAtZero: false } }
        }
    });
    // Données fictives pour la répartition produits
    const productPie = document.getElementById('productPie').getContext('2d');
    new Chart(productPie, {
        type: 'pie',
        data: {
            labels: ['Colis Sec', 'Colis Frais', 'Express', 'Temp. Ambiante'],
            datasets: [{
                data: [35, 45, 12, 8],
                backgroundColor: ['#facc15', '#22d3ee', '#6366f1', '#fbbf24'],
                borderWidth: 1,
            }]
        },
        options: {
            plugins: { legend: { position: 'bottom' } },
            responsive: true,
        }
    });
    </script>
</div>

<style>
table thead th, table tbody td {
    padding: 0.75rem; /* espace dans les cellules */
    text-align: center; /* alignement horizontal */
    vertical-align: middle; /* alignement vertical */
    white-space: nowrap; /* évite les sauts de ligne dans les colonnes */
}
</style>

{% endblock %}